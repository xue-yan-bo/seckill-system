# 二维码支付功能说明

## 🎉 功能概述

已成功在订单支付功能中添加二维码支付，用户点击"支付"按钮后会弹出二维码支付对话框。

## 🚀 使用步骤

### 1. 访问系统
在浏览器中打开：http://localhost:3000

### 2. 登录账号
- 用户名：`admin`
- 密码：`123456`

### 3. 参与秒杀
1. 点击导航栏的"秒杀活动"
2. 选择一个商品，点击"立即秒杀"
3. 秒杀成功后会自动创建待支付订单

### 4. 查看订单
1. 点击导航栏的"我的订单"
2. 找到状态为"待支付"的订单

### 5. 扫码支付
1. 点击订单右侧的"支付"按钮
2. 弹出支付二维码对话框
3. 对话框会显示：
   - 订单号
   - 支付金额
   - 支付二维码（您可以自定义为您的收款码）
   - 支付说明

### 6. 完成支付

#### 方式一：实际扫码支付（需要配置真实收款码）
- 用户使用微信或支付宝扫描二维码
- 支付成功后，系统会自动检测并更新订单状态

#### 方式二：演示模拟支付（当前可用）
- 点击对话框中的"🎯 模拟支付成功（演示用）"按钮
- 订单状态立即更新为"已支付"
- 对话框自动关闭

## 📝 技术实现

### 前端功能
1. **二维码显示**：使用QRCode库生成二维码图片
2. **状态轮询**：每2秒自动检查支付状态
3. **自动更新**：支付成功后自动刷新订单列表

### 后端接口
1. **生成二维码**：`POST /api/order/qrcode/:id`
2. **查询支付状态**：`GET /api/order/payment/status/:paymentId`
3. **支付回调**：`POST /api/order/payment/callback/:paymentId`

## 🔧 自定义您的收款二维码

### 方法1：修改二维码内容（推荐）

编辑文件：`mock-server/server.js`（第242行）

```javascript
// 替换为您的微信或支付宝收款链接
const paymentUrl = `您的收款链接或信息-订单号:${order.orderNo}-金额:${order.totalAmount}元`;
```

**示例：**
```javascript
// 微信收款
const paymentUrl = `wxp://你的微信收款码ID-订单:${order.orderNo}-¥${order.totalAmount}`;

// 支付宝收款
const paymentUrl = `alipays://platformapi/你的支付宝收款码-${order.orderNo}-${order.totalAmount}`;

// 自定义文本（用户扫码后看到）
const paymentUrl = `微信号：your_wechat_id\n支付宝账号：your_alipay@email.com\n订单：${order.orderNo}\n金额：¥${order.totalAmount}元\n请备注订单号`;
```

### 方法2：直接使用收款码图片

如果您已有收款码图片：

1. 将您的收款码图片放到 `frontend/public/` 目录
2. 修改 `mock-server/server.js`（第264行）：

```javascript
res.json({
  code: 200,
  data: {
    paymentId,
    qrcode: '/your-qrcode.jpg', // 您的收款码图片路径
    amount: order.totalAmount,
    orderNo: order.orderNo
  }
});
```

## 🎯 实际生产环境对接

在真实生产环境中，您需要：

### 1. 对接支付平台
- **微信支付**：申请微信商户号，使用Native支付
- **支付宝**：申请支付宝商户号，使用当面付
- **其他平台**：如PayPal、Stripe等

### 2. 替换生成二维码接口
```javascript
app.post('/api/order/qrcode/:id', async (req, res) => {
  // 调用真实支付平台API
  const result = await wechatPay.createOrder({
    orderId: order.orderNo,
    amount: order.totalAmount,
    description: order.productName
  });
  
  // 返回支付平台生成的二维码
  res.json({
    code: 200,
    data: {
      paymentId: result.paymentId,
      qrcode: result.qrcodeUrl, // 支付平台返回的二维码URL
      amount: order.totalAmount,
      orderNo: order.orderNo
    }
  });
});
```

### 3. 配置支付回调
支付平台会在支付成功后回调您的服务器：

```javascript
// 接收支付平台的回调
app.post('/api/payment/notify', async (req, res) => {
  // 验证签名
  const isValid = verifySign(req.body);
  if (!isValid) {
    return res.status(403).send('签名验证失败');
  }
  
  // 更新订单状态
  const { orderId, status } = req.body;
  if (status === 'SUCCESS') {
    await updateOrderStatus(orderId, 1);
  }
  
  res.send('SUCCESS');
});
```

## 📦 当前演示功能

### ✅ 已实现
- 二维码生成和显示
- 支付状态实时轮询
- 支付成功自动更新订单
- 美观的支付对话框UI
- 模拟支付功能（演示用）

### ⚠️ 演示限制
- 使用Mock服务器，数据存储在内存中
- 二维码内容为示例文本
- 需要手动点击"模拟支付"完成支付
- 重启服务后数据会丢失

### 🚀 生产环境需要
- 真实支付平台对接
- 数据库持久化存储
- 支付安全验证
- 支付异常处理
- 退款功能

## 📞 常见问题

### Q1: 如何放置我自己的二维码？
A: 参考上面"自定义您的收款二维码"部分，修改 `mock-server/server.js` 文件。

### Q2: 扫码后支付为什么不能自动完成？
A: 当前是演示版本，需要点击"模拟支付成功"按钮。真实环境需要对接支付平台的回调接口。

### Q3: 如何对接真实支付平台？
A: 需要申请支付平台商户号，集成官方SDK，并配置回调接口。详见"实际生产环境对接"部分。

### Q4: 可以同时支持微信和支付宝吗？
A: 可以。在支付对话框中显示两个二维码，或者让用户选择支付方式。

## 🎨 界面预览

支付对话框包含：
- 📋 订单信息（订单号、金额）
- 🎯 支付二维码（300x300像素）
- 💡 支付说明提示
- 🔄 自动状态检测
- ✅ 演示用模拟支付按钮

## 📄 相关文件

- 前端页面：`frontend/src/views/Order.vue`
- 前端API：`frontend/src/api/order.js`
- 后端接口：`mock-server/server.js`

## 🎉 开始使用

1. 确保前端和后端服务都在运行
2. 访问 http://localhost:3000
3. 登录 → 秒杀 → 查看订单 → 点击支付
4. 查看二维码支付对话框
5. 点击"模拟支付成功"完成支付

祝您使用愉快！🎊

